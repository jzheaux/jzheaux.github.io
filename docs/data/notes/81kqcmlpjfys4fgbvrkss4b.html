<h1 id="tips"><a aria-hidden="true" class="anchor-heading icon-link" href="#tips"></a>Tips</h1>
<h2 id="authorization"><a aria-hidden="true" class="anchor-heading icon-link" href="#authorization"></a>Authorization</h2>
<p>Everyone wants to create their own API, and that makes sense. We want our app to look like our domain.</p>
<p>Historically, Spring Security has one way to do this: SpEL.
It's done by publishing a custom <code>MethodSecurityExpressionHandler</code>, which handler returns a <code>SecurityExpressionRoot</code> instance that has the application's custom expressions.
This allows the application to do:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"isSubscribed() || isAdmin()"</span><span class="token punctuation">)</span>
</code></pre>
<p>While I appreciate the readability of this, I'd prefer something more like the following:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Authorize</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Subscribed</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Admin</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>This is more testable because I can have unit tests for <code>Subscribed.class</code> and for <code>Admin.class</code>.</p>
<p>So, how do we achieve that?</p>
<p>First, create the annotation:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"permitAll()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Authorize</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationManager</span><span class="token punctuation">&#x3C;</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Second, create an interceptor:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeAuthorizationManager</span> <span class="token keyword">implements</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityAnnotationScanner</span> authorize <span class="token operator">=</span> <span class="token class-name">SecurityAnnotationScanners</span><span class="token punctuation">.</span><span class="token function">fromAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Authorize</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Class</span><span class="token punctuation">&#x3C;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">AuthorizationManager</span><span class="token punctuation">&#x3C;</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">></span><span class="token punctuation">></span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationDecision</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">Authentication</span><span class="token punctuation">></span></span> authentication<span class="token punctuation">,</span> <span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Authorize</span> authorize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authorize<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authorize <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">AuthorizationManagers</span><span class="token punctuation">.</span><span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>authorize<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">manager</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">></span></span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">newInstance</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&#x3C;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span>computeIfAbsentclazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And then finally, publish an interceptor:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token class-name">MethodInterceptor</span> <span class="token function">authorizeInterceptor</span><span class="token punctuation">(</span><span class="token class-name">AuthorizeAuthorizationManager</span> authorize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> interceptor <span class="token operator">=</span> <span class="token class-name">AuthorizationManagerBeforeMethodInterceptor</span><span class="token punctuation">.</span><span class="token function">preAuthorize</span><span class="token punctuation">(</span>authorize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interceptor<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token class-name">AuthorizeInterceptorOrder</span><span class="token punctuation">.</span>PRE_AUTHORIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This allows you to unit-test the authorization classes and get compile-time feedback on authorization expressions.</p>
<hr>
<h2 id="tags"><a aria-hidden="true" class="anchor-heading icon-link" href="#tags"></a>Tags</h2>
<ol>
<li><a title="Private" href="https://wiki.dendron.so/notes/hfyvYGJZQiUwQaaxQO27q.html" target="_blank" class="private">spring-security (Private)</a></li>
</ol>